(window.webpackJsonp=window.webpackJsonp||[]).push([[9],{401:function(t,s,n){"use strict";n.r(s);var a=n(42),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"经纪人端微聊小程序"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#经纪人端微聊小程序"}},[t._v("#")]),t._v(" 经纪人端微聊小程序")]),t._v(" "),n("br"),t._v(" "),n("h2",{attrs:{id:"基本信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本信息"}},[t._v("#")]),t._v(" 基本信息")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("简介")]),t._v(" "),n("p",[t._v("针对内部经纪人使用的微聊小程序，主要内嵌在【企业微信】中使用(也支持迁移至【微信】)，目前已上线城市：深圳、广州、香港、集团（除上海）所有城市。")])]),t._v(" "),n("p",[n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"对应线上应用"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#对应线上应用"}},[t._v("#")]),t._v(" 对应线上应用")]),t._v(" "),n("p",[n("strong",[t._v("小程序码(所有城市通用)：")]),n("br"),t._v(" "),n("a",{attrs:{"data-fancybox":"",title:"qrcode.png",href:"/assets/qrcode.jpg"}},[n("img",{attrs:{src:"/assets/qrcode.jpg",alt:"qrcode.png"}})]),t._v(" "),n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"git-地址"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#git-地址"}},[t._v("#")]),t._v(" GIT 地址")]),t._v(" "),n("p",[n("a",{attrs:{href:"http://gitlab.centaline.com.cn/centnet-group/centanet/tools/chat-wepy2.0",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://gitlab.centaline.com.cn/centnet-group/centanet/tools/chat-wepy2.0"),n("OutboundLink")],1),n("br"),t._v(" "),n("strong",[t._v("开发分支：")]),t._v(" dev 分支"),n("br"),t._v(" "),n("strong",[t._v("线上分支：")]),t._v(" master 分支\n"),n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"管理后台"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#管理后台"}},[t._v("#")]),t._v(" 管理后台")]),t._v(" "),n("p",[n("strong",[t._v("小程序运营后台：")]),t._v(" "),n("a",{attrs:{href:"https://mp.weixin.qq.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://mp.weixin.qq.com/"),n("OutboundLink")],1),n("br"),t._v(" "),n("strong",[t._v("运营对应账号：")]),t._v(" centachats@163.com（密码询 PM）\n"),n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"对接人员"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#对接人员"}},[t._v("#")]),t._v(" 对接人员")]),t._v(" "),n("p",[n("strong",[t._v("前端：")]),t._v(" 黄宽"),n("br"),t._v(" "),n("strong",[t._v("Talk API：")]),t._v(" 李松松"),n("br"),t._v(" "),n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"配置相关信息"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#配置相关信息"}},[t._v("#")]),t._v(" 配置相关信息")]),t._v(" "),n("p",[n("strong",[t._v("api 地址：")]),t._v(" "),n("a",{attrs:{href:"https://talk.centanet.com/im/%5D(https://talk.centanet.com/im/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://talk.centanet.com/im/](https://talk.centanet.com/im/"),n("OutboundLink")],1),n("br"),t._v(" "),n("strong",[t._v("获取快捷回复配置：")]),t._v(" "),n("a",{attrs:{href:"https://static.centanet.com/wap/config/quickreply.json",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://static.centanet.com/wap/config/quickreply.json"),n("OutboundLink")],1),n("br"),t._v(" "),n("strong",[t._v("获取登录配置：")]),t._v(" "),n("a",{attrs:{href:"https://static.centanet.com/wap/config/cityconfig.json",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://static.centanet.com/wap/config/cityconfig.json"),n("OutboundLink")],1),n("br"),t._v(" "),n("strong",[t._v("小程序 appid：")]),t._v(" wxced3539c370df72e"),n("br"),t._v(" "),n("strong",[t._v("云信 appKey：")]),t._v(" d70fe05fbd6d8abf318c3eaf6d046ead\n"),n("br"),n("br")]),t._v(" "),n("h3",{attrs:{id:"项目框架"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#项目框架"}},[t._v("#")]),t._v(" 项目框架")]),t._v(" "),n("p",[n("strong",[t._v("小程序框架：")]),t._v(" wepy"),n("br"),t._v(" "),n("strong",[t._v("脚手架版本：")]),t._v(" @wepy/cli 2.0.0-alpha.28"),n("br"),t._v(" "),n("strong",[t._v("云信 SDK：")]),t._v(" v7.9.0"),n("br"),t._v(" "),n("strong",[t._v("UI 框架：")]),t._v(" vant weapp 1.6.1")]),t._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),n("p",[t._v("由于 wepy 框架的特殊性，UI 框架 vant weapp 已单独提取至项目下 weapp/compnents/vant 文件夹，无须通过 npm 安装引入。")])]),t._v(" "),n("p",[n("br"),n("br")]),t._v(" "),n("h3",{attrs:{id:"项目结构"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#项目结构"}},[t._v("#")]),t._v(" 项目结构")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("具体目录结构,以及对应目录-功能模块参考：")]),t._v(" "),n("pre",{staticClass:"vue-container"},[n("code",[n("p",[t._v("centanet-tools-chat-2.0\n├─ .editorconfig\n├─ .gitignore\n├─ .prettierrc\n├─ .wepycache\n├─ .wepyignore\n├─ package-lock.json\n├─ package.json\n├─ project.config.json\n├─ src\n│ ├─ app.wpy\n│ ├─ "),n("code",[t._v("common")]),t._v(" --公共文件夹\n│ │ ├─ "),n("code",[t._v("config.js")]),t._v(" --全局配置\n│ │ ├─ eventHub.js --事件订阅\n│ │ ├─ iconfont.less --图标样式文件\n│ │ ├─ nim.v7.9.0.js --云信 SDK\n│ │ ├─ "),n("code",[t._v("public.js")]),t._v(" --公共 js 文件\n│ │ └─ "),n("code",[t._v("style.less")]),t._v(" --公共样式文件\n│ ├─ components --组件\n│ │ └─ vant --vant UI 框架文件夹\n│ │ ├─ button\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ cell\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ cell-group\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ common\n│ │ │ ├─ color.js\n│ │ │ ├─ component.js\n│ │ │ ├─ index.wxss\n│ │ │ ├─ style\n│ │ │ │ ├─ clearfix.wxss\n│ │ │ │ ├─ ellipsis.wxss\n│ │ │ │ ├─ hairline.wxss\n│ │ │ │ ├─ mixins\n│ │ │ │ │ ├─ clearfix.wxss\n│ │ │ │ │ ├─ ellipsis.wxss\n│ │ │ │ │ └─ hairline.wxss\n│ │ │ │ ├─ theme.wxss\n│ │ │ │ └─ var.wxss\n│ │ │ ├─ utils.js\n│ │ │ └─ version.js\n│ │ ├─ dialog\n│ │ │ ├─ dialog.js\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ goods-action\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ goods-action-button\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ icon\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ info\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ loading\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ mixins\n│ │ │ ├─ basic.js\n│ │ │ ├─ button.js\n│ │ │ ├─ link.js\n│ │ │ ├─ open-type.js\n│ │ │ ├─ page-scroll.js\n│ │ │ ├─ touch.js\n│ │ │ └─ transition.js\n│ │ ├─ overlay\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ popup\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ ├─ transition\n│ │ │ ├─ index.js\n│ │ │ ├─ index.json\n│ │ │ ├─ index.wxml\n│ │ │ └─ index.wxss\n│ │ └─ wxs\n│ │ ├─ add-unit.wxs\n│ │ ├─ array.wxs\n│ │ ├─ bem.wxs\n│ │ ├─ memoize.wxs\n│ │ ├─ object.wxs\n│ │ └─ utils.wxs\n│ ├─ "),n("code",[t._v("mixins")]),t._v(" --会话详情页和聊天记录页通用方法\n│ │ └─ common.js\n│ ├─ "),n("code",[t._v("pages")]),t._v(" --核心页面\n│ │ ├─ details.wpy --会话详情页\n│ │ ├─ fix.wpy --异常修复功能\n│ │ ├─ history.wpy --聊天记录页\n│ │ ├─ list.wpy --会话列表页\n│ │ ├─ log.wpy --日志记录(多次点击版本号进入此页面)\n│ │ ├─ login.wpy --登录授权页\n│ │ ├─ my.wpy --个人中心页面\n│ │ ├─ setting.wpy --设置页面\n│ │ ├─ towechat.wpy --迁移至微信功能\n│ │ └─ webview.wpy --嵌套 webview 通用页面\n│ ├─ "),n("code",[t._v("plugins")]),t._v("\n│ │ ├─ axios.js --http 改造插件\n│ │ └─ im.js --im 核心功能\n│ ├─ "),n("code",[t._v("static")]),t._v(" --公共静态文件\n│ │ └─ img\n│ │ ├─ centanet.png\n│ │ ├─ fix.png\n│ │ ├─ groups.png\n│ │ ├─ list.png\n│ │ ├─ list*.png\n│ │ ├─ logo.png\n│ │ ├─ my.png\n│ │ ├─ my*.png\n│ │ ├─ search.png\n│ │ ├─ search_.png\n│ │ ├─ staff.png\n│ │ ├─ wechat.png\n│ │ └─ xiaomu.png\n│ └─ "),n("code",[t._v("store")]),t._v(" --全局数据状态管理\n│ └─ index.js\n└─ "),n("code",[t._v("wepy.config.js")]),t._v(" --wepy 框架配置文件")]),t._v("\n")])]),n("h2",{attrs:{id:"注意事项"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),n("h3",{attrs:{id:"_1-异常监控与事件上报"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-异常监控与事件上报"}},[t._v("#")]),t._v(" 1.异常监控与事件上报")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("为便于报障排查问题，所有可能导致连接断开、微聊无法使用的场景下， 代码中都做了异常监控与日志上报。"),n("br"),t._v("\n日志上报使用微信官方提供的“实时日志”记录功能。"),n("br"),t._v("\n错误状态码整理如下")]),t._v(" "),n("table",[n("thead",[n("tr",[n("th",[t._v("错误码")]),t._v(" "),n("th",[t._v("错误释义")])])]),t._v(" "),n("tbody",[n("tr",[n("td",[t._v("无")]),t._v(" "),n("td",[t._v("日志记录中无状态码，则为主动上报，连续多次点击【我的】=>【版本号】,将"),n("br"),t._v("跳转日志记录页，并主动提交日志")])]),t._v(" "),n("tr",[n("td",[t._v("102")]),t._v(" "),n("td",[t._v("SDK 断开连接时触发，具体原因将记录并输出，一般为网络超时、token 失效、"),n("br"),t._v("其他端登录被踢等")])]),t._v(" "),n("tr",[n("td",[t._v("103")]),t._v(" "),n("td",[t._v("获取列表失败时触发，一般为拉取会话列表超时，或执行拉取列表方法时，连"),n("br"),t._v("接已为断开状态")])]),t._v(" "),n("tr",[n("td",[t._v("104")]),t._v(" "),n("td",[t._v("清理未读消息时失败，多为列表字段异常，导致读取写入失败")])]),t._v(" "),n("tr",[n("td",[t._v("105")]),t._v(" "),n("td",[t._v("会话列表组装失败，云端会话列表和本地会话列表合并时，抛出此异常")])]),t._v(" "),n("tr",[n("td",[t._v("108")]),t._v(" "),n("td",[t._v("SDK 回调异常，SDK 触发任意错误，触发此方法，具体原因将记录并输出")])])])]),t._v(" "),n("h3",{attrs:{id:"_2-小程序后台日志查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-小程序后台日志查询"}},[t._v("#")]),t._v(" 2.小程序后台日志查询")]),t._v(" "),n("hr"),t._v(" "),n("p",[n("strong",[t._v("路径：")]),t._v(" 【开发】=>【开发管理】=>【运维中心】=>【实时日志】"),n("br"),t._v("\n访问以上路径 即可查询每天上报的日志"),n("br"),t._v(" "),n("a",{attrs:{"data-fancybox":"",title:"",href:"/assets/log-1.jpg"}},[n("img",{attrs:{src:"/assets/log-1.jpg",alt:""}})]),t._v(" "),n("a",{attrs:{"data-fancybox":"",title:"",href:"/assets/log-2.jpg"}},[n("img",{attrs:{src:"/assets/log-2.jpg",alt:""}})])]),t._v(" "),n("br"),t._v(" "),n("h3",{attrs:{id:"_3-新消息提醒逻辑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-新消息提醒逻辑"}},[t._v("#")]),t._v(" 3.新消息提醒逻辑")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("当产生新消息时，列表页将展示小圆点提醒经纪人未读消息，考虑性能原因，部分条件下的会话将自动设置为已读。具体规则&参考代码：")]),t._v(" "),n("ul",[n("li",[n("ol",[n("li",[t._v("没有正在进行中的会话,针对会话 id 写入小圆点提醒。")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"2"}},[n("li",[t._v("有正在进行中的会话,但非当前 id,也写入小圆点提醒(正在对话中的会话不写入提醒)。")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"3"}},[n("li",[t._v("超过 3 天会话不写更新状态 默认已读,不写入小圆点提醒。")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"4"}},[n("li",[t._v("若为退群消息，无条件标记为已读，不写入小圆点提醒")])])]),t._v(" "),n("li",[n("ol",{attrs:{start:"5"}},[n("li",[t._v("用户点击进入【我的】页面时，开始检测本地消息，搜寻 3 天以上的会话，设置为已读。")])])])]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 路径：/src/store/index.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//写入新消息提醒列表，tipList数组为专门本地存放已读/未读消息的数组")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTipList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stamp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//定义会话的最迟提醒时间（超过3天会话不写更新状态 默认已读）")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" date "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Date")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("259200000")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//console.log('更新新消息提醒列表', state, list, chatId);")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" tipList "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" pub"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("simpleCopy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//浅拷贝小圆点列表")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//只处理7天内的会话,3天后的会话默认已读 不处理")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("stamp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" date "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" stamp"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n        type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'add'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n        chatId "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("currentSession "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("currentSession "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("currentSession"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatId "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" state"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stamp"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" stamp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'del'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" state"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stamp"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" stamp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'list'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//来自于列表 循环对比消息，若为退群消息，无条件标记为已读，不写入小圆点提醒")]),t._v("\n      list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n          e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatId "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n          tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("undefined")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n          date "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stamp "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n          e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lastMsg"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("indexOf")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'退出了群聊'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" state"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" stamp"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("stamp "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//条件都不满足,超过3天的会话 自动设置为已读")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("delete")]),t._v(" tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("chatId"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//组装完成，开始写入已读列表")]),t._v("\n    state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tipList "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tipList\n    wx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setStorage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" key"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tipList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" data"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" tipList "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//异常捕获， 组装是失败时，上报日志至微信小程序后台")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" log "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" wx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getRealtimeLogManager "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" wx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getRealtimeLogManager")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("null")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      wx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeStorage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" key"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'tipList'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//清空用户信息列表")]),t._v("\n      log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'———————tipList组装失败105———————'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("state"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tipList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("wx"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getStorageSync")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'userInfo'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      log"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("error")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("br"),t._v(" "),n("h3",{attrs:{id:"_4-更新会话头像和群-id-逻辑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-更新会话头像和群-id-逻辑"}},[t._v("#")]),t._v(" 4.更新会话头像和群 ID 逻辑")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("并非所有消息都会携带会话 ID 与头像，客户消息和系统消息必定携带，经纪人小程序端、IOS 端必定携带，Android 经纪人端不携带。"),n("br"),t._v("\n因此应优先从消息体中获取以上字段，若获取不到，则降级处理，从云信端批量获取群资料，合并写入本地内存中。具体规则参考代码：")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 路径：/src/store/index.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//逻辑：优先从会话最后一条消息中取群头像和群ID,若没有取到(从安卓端发出的消息,不带扩展字段,无法取到),")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//则创建promise批量从云信获取群资料,再合并数组,写入会话列表")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("setSessionList")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" list")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'list'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//判断消息类型，若为对象则是单条会话，转为数组，若为多条会话的数组则不处理。")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("constructor "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" Object"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    list "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'object'")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" promiseList "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//遍历所有会话，若没有【有效/无效标记】【头像】【会话ID】三个字段中的任意一个，创建promise批量从云信获取")]),t._v("\n  list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" i")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("invalid "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("invalid "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatId "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("head"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      promiseList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("wepy"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$im"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("getTeam")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" promiseList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("resolve")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" error"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" e "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  Promise"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("all")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("promiseList"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//遍历批量获取的接口，开始合并组装云端&本地会话的扩展字段，写入内存")]),t._v("\n    res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("forEach")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" i")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("error "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("let")]),t._v(" custom "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("try")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          custom "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("parse")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("res"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("serverCustom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("catch")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("error"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isDel "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" custom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("IsClosured "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" custom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Invalid\n        list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatName "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" custom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ChatId\n          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" custom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ChatName "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'官网聊天会话'")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'官网会话聊天'")]),t._v("\n        list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("chatId "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" custom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ChatId\n        list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("head "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n          custom"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("OwnerIcon "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'https://static.centanet.com/wap/img/chat/groups.png'")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//合并组装完成后写入Vuex中，多条会话直接向下拼接，单条会话则置于列表顶部")]),t._v("\n    context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("commit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'setTipList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" type"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'list'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    type "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'list'")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("commit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'pushSessionList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" context"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("commit")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'unshiftSessionList'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" list"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"扩展功能"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#扩展功能"}},[t._v("#")]),t._v(" 扩展功能")]),t._v(" "),n("h3",{attrs:{id:"_1-用户轨迹"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-用户轨迹"}},[t._v("#")]),t._v(" 1.用户轨迹")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("数据来自官网，展示用户历史浏览的房源和店铺记录。"),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 规则：")]),n("br"),t._v("\nhttps://esf.centanet.com/tools/viewhistory/?userid="),n("code",[t._v("用户编号")]),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 示例：")]),n("br"),t._v(" "),n("a",{attrs:{href:"http://esf.centanet.com/tools/viewhistory/?userid=U121516283",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://esf.centanet.com/tools/viewhistory/?userid=U121516283"),n("OutboundLink")],1)]),t._v(" "),n("br"),t._v(" "),n("h3",{attrs:{id:"_2-发送房源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-发送房源"}},[t._v("#")]),t._v(" 2.发送房源")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("用于向客户推送房源，内嵌官网 m 站经纪人店铺页，chatmode=1 为固定参数，"),n("br"),t._v("\n经纪人店铺页识别到此参数时，将只展示发送房源相关参数。"),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 规则：")]),n("br"),t._v("\nhttps://wap.centanet.com/tj/jingjiren/esf-"),n("code",[t._v("经纪人工号")]),t._v("/?chatmode=1"),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 示例：")]),n("br"),t._v(" "),n("a",{attrs:{href:"https://wap.centanet.com/tj/jingjiren/esf-tj19020017/?chatmode=1",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://wap.centanet.com/tj/jingjiren/esf-tj19020017/?chatmode=1"),n("OutboundLink")],1)]),t._v(" "),n("br"),t._v(" "),n("h3",{attrs:{id:"_3-邀请经纪人进群"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-邀请经纪人进群"}},[t._v("#")]),t._v(" 3.邀请经纪人进群")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("用于邀请同事加入会话的功能。"),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 规则：")]),n("br"),t._v("\nhttps://esf.centanet.com/tools/chat/invite.html?k=333&userid="),n("code",[t._v("经纪人完整工号")]),t._v("&chatid="),n("code",[t._v("会话chatid")]),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 示例：")]),n("br"),t._v(" "),n("a",{attrs:{href:"https://esf.centanet.com/tools/chat/invite.html?userid=s_024_guanliyuan1&chatid=chat545124815",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://esf.centanet.com/tools/chat/invite.html?userid=s_024_guanliyuan1&chatid=chat545124815"),n("OutboundLink")],1)]),t._v(" "),n("br"),t._v(" "),n("h3",{attrs:{id:"_4-激活历史会话"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-激活历史会话"}},[t._v("#")]),t._v(" 4.激活历史会话")]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("用于新旧版微聊过渡期间，找回旧版微聊会话的功能。也用于查询旧版会话中的聊天记录。"),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 规则：")]),n("br"),t._v("\nhttps://esf.centanet.com/tools/chat/activate.html?userid="),n("code",[t._v("经纪人完整工号")]),n("br"),t._v(" "),n("strong",[t._v("跳转 URL 示例：")]),n("br"),t._v(" "),n("a",{attrs:{href:"https://esf.centanet.com/tools/chat/activate.html?userid=s_024_guanliyuan1",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://esf.centanet.com/tools/chat/activate.html?userid=s_024_guanliyuan1"),n("OutboundLink")],1)]),t._v(" "),n("p",[n("br"),n("br")]),t._v(" "),n("h2",{attrs:{id:"发版流程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#发版流程"}},[t._v("#")]),t._v(" 发版流程")]),t._v(" "),n("h3",{attrs:{id:"构建生产包"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#构建生产包"}},[t._v("#")]),t._v(" 构建生产包")]),t._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[t._v("提示")]),t._v(" "),n("p",[t._v("构建打包时，建议退出微信开发者工具，防止文件占用部分文件生成失败。")])]),t._v(" "),n("hr"),t._v(" "),n("p",[t._v("在程序目录执行 cmd 命令"),n("code",[t._v("npm run build")]),t._v(" 构建生产包,输出示例,出现"),n("code",[t._v("build finished")]),t._v("相关提示,且无错误输出 则构建成功"),n("br"),t._v("\n构建文件路径： "),n("code",[t._v("项目根目录/weapp/")])]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[t._v("\n\nE:"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("git-new"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("centanet-tools-chat-2."),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v("npm run build\n\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" chat@0.0.2 build E:"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("git-new"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("centanet-tools-chat-2.0\n"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" cross-env "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("NODE_ENV")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("production ./node_modules/.bin/wepy build --no-cache\n\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:23"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info build app start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info app building App\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info component building components\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info component building components\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info component building components\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info component building components\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info vendor building vendor\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info assets building assets\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("17")]),t._v(":27:27"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" info build finished\n\nE:"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("git-new"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("centanet-tools-chat-2."),n("span",{pre:!0,attrs:{class:"token operator"}},[n("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v("\n")])])]),n("hr"),t._v(" "),n("h3",{attrs:{id:"提交审核并发布"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#提交审核并发布"}},[t._v("#")]),t._v(" 提交审核并发布")]),t._v(" "),n("hr"),t._v(" "),n("ul",[n("li",[t._v("根据上一步构建好生产包以后，生成的"),n("code",[t._v("weapp")]),t._v("文件夹即为小程序包，在开发者工具右上角提交体验版， 并在小程序后台提交审核即可")])])])}),[],!1,null,null,null);s.default=e.exports}}]);